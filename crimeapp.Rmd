---
title: "Chicago Crime"
author: "Rebecca Oh"
output: html_document
runtime: shiny
---

```{r load_packages, include=FALSE}
library(tidyverse)
library(DBI)
library(dbplyr)
library(dplyr)
library(bigrquery)
library(tidyverse)
library(plotly)
library(DT)
library(ggvis)
library(shiny)
library(gapminder)
library(RSocrata)
library(lubridate)
```

## Google BigQuery Project ID

I used Google BigQuery with the following project ID to initialize the crime data.

```{r}
project <- "planar-ember-256702"
```

## Connecting to Chicago Crime Database

I used the Chicago crime database and set up the connection to the database.

```{r}
con <- dbConnect(
  bigrquery::bigquery(),
  project = "bigquery-public-data",
  dataset = "chicago_crime",
  billing = project
)
con 
```

## Preparing Data

I wrote queries from within R via the `DBI` package. I am interested in the number of arrests grouped by year, district, and primary type of crime.

```{r}
#query object that fulfills the above
sql <- "SELECT year, district, primary_type, COUNT(*) AS arrests 
        FROM `bigquery-public-data.chicago_crime.crime` 
        WHERE arrest = TRUE
        GROUP BY year, district, primary_type"

#converting data to .csv to import into github
write.csv(crime,'C:\\Users\\Rebecca Oh\\Documents\\crimeapp\\crime.csv', row.names = FALSE)

#reading data from github
crime <- read_csv("https://raw.githubusercontent.com/daraeoh/Chicago-Crime-App/master/crime.csv")
```

# Define UI
```{r}
ui <- fluidPage(
  
  # App title
  titlePanel("Chicago Crime Visualization"),
  
  br(),
  
  h5("Author: Rebecca Oh"),
  
  br(),
  
  # Sidebar layout with input and output definitions
  ui <- fluidPage(
  
   sidebarLayout(
     
     # Inputs
     sidebarPanel(
       
       # Select district number
       selectInput(inputId = "district",
                   label = "District",
                   choices = c("1 (Central)", "2 (Wentworth)", "3 (Grand Crossing)", "4 (South Chicago)", "5 (Calumet)",
                               "6 (Gresham)", "7 (Englewood)", "8 (Chicago Lawn)", "9 (Deering)", "10 (Ogden)", 
                               "11 (Harrison)", "12 (Near West)", "14 (Shakespeare)", "15 (Austin)", 
                               "16 (Jefferson Park)", "17 (Albany Park)", "18 (Near North)", "19 (Town Hall)", 
                               "20 (Lincoln)", "21", "22 (Morgan Park)", "24 (Rogers Park)", 
                               "25 (Grand Central)", "31") %>% unique(),
                   selected = "1 (Central)"),
       
       # Slide year range
       sliderInput(inputId = "year",
                   label = "Range of years",
                   min = 2001,
                   max = 2019,
                   value = c(2001, 2019), 
                   sep = ""),
       
       # Select crime type
       checkboxGroupInput(inputId = "primary_type",
                     label = "Choose a primary type of crime",
                     choices = c("ARSON", "ASSAULT", "BATTERY", "BURGLARY", "CONCEALED CARRY LICENSE VIOLATION", 
                                 "CRIMINAL DAMAGE", "CRIMINAL TRESPASS", "CRIM SEXUAL ASSAULT", "DECEPTIVE PRACTICE", 
                                 "GAMBLING", "HOMICIDE", "INTERFERENCE WITH PUBLIC OFFICER", "INTIMIDATION", 
                                 "KIDNAPPING", "LIQUOR LAW VIOLATION", "MOTOR VEHICLE THEFT", "NARCOTICS", 
                                 "NON-CRIMINAL (SUBJECT SPECIFIED)", "OBSCENITY", "OTHER NARCOTIC VIOLATION", 
                                 "OTHER OFFENSE", "OFFENSE INVOLVING CHILDREN", "PROSTITUTION", "PUBLIC INDECENCY", 
                                 "PUBLIC PEACE VIOLATION", "ROBBERY", "SEX OFFENSE", "STALKING", "THEFT", "WEAPONS VIOLATION"),
                     selected = "ARSON")
     ),
     
     # Outputs
     mainPanel(
       position = "left",
       plotlyOutput(outputId = "scatterplot")
     )
   )
  )
)
```

# Server
```{r}
# Define server function
server <- function(input, output) {
  
  # Create data
  crime2 <- reactive({
    crime %>%
      group_by(district == as.vector(input$district)) %>%
      filter(year >= as.integer(input$year[1]) & year <= as.integer(input$year[2])) %>%
      filter(primary_type == input$primary_type)
  })
  
  # Create scatterplot object
  output$scatterplot <- renderPlotly({
    p <- ggplot(data = crime2(), aes(x = year, y = arrests)) +
      geom_point(aes(color = primary_type)) +
      geom_smooth(method = 'loess') +
      theme_light() +
      labs(title = paste0("Chicago Crimes in District ", input$district),
           x = "Year",
           y = "Number of Arrests",
           color = "Primary Type of Crime")
    ggplotly(p)
  })
}
```

# Run the Shiny application
```{r}
shinyApp(ui = ui, server = server)
```
