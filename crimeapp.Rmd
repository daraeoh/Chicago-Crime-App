---
title: "Chicago Crime"
author: "Rebecca Oh"
output: html_document
runtime: shiny
---

```{r load_packages, include=FALSE}
library(tidyverse)
library(DBI)
library(dbplyr)
library(dplyr)
library(bigrquery)
library(tidyverse)
library(plotly)
library(DT)
library(ggvis)
library(shiny)
library(gapminder)
```

## Google BigQuery Project ID

I used Google BigQuery with the following project ID to initialize the crime data.

```{r}
project <- "planar-ember-256702"
```

## Connecting to Chicago Crime Database

I used the Chicago crime database and set up the connection to the database.

```{r}
con <- dbConnect(
  bigrquery::bigquery(),
  project = "bigquery-public-data",
  dataset = "chicago_crime",
  billing = project
)
con 
```

## Preparing Data

I wrote queries from within R via the `DBI` package. I am interested in the number of arrests grouped by year, district, and primary type of crime.

```{r}
#query object that fulfills the above
sql <- "SELECT year, district, primary_type, COUNT(*) AS arrests 
        FROM `bigquery-public-data.chicago_crime.crime` 
        WHERE arrest = TRUE
        GROUP BY year, district, primary_type"

#converting data to .csv to import into github
write.csv(crime,'C:\\Users\\Rebecca Oh\\Documents\\crimeapp\\crime.csv', row.names = FALSE)

#reading data from github
crime <- read_csv("https://raw.githubusercontent.com/daraeoh/Chicago-Crime-App/master/crime.csv")
```

```{r}
x_axis <- input_slider(
  min = 2001, 
  max = 2019, 
  value = c(2001, 2019), 
  label = "Range of Years", 
  sep = "")

if (interactive()) {

runApp(list(
  ui = bootstrapPage(
    ggvisOutput("p"),
    uiOutput("p_ui")
  ),
  server = function(..., session) {
    crime %>%
     ggvis(x = ~year, y = ~arrests, fill = ~primary_type) %>%
      filter(district %in% eval(input_select(choices = levels(factor(as.vector(unique(crime$district)), 
                                                                    levels = c("1", "2", "3", "4", "5", 
                                                                                "6", "7", "8", "9", "10", 
                                                                                "11", "12", "14", "15", 
                                                                                "16", "17", "18", "19", 
                                                                                "20", "21", "22", "24", 
                                                                                "25", "31"))), 
                                            selected = "1", label = "District"))) %>%
      scale_numeric("x", domain = x_axis, clamp = T) %>%
      filter(primary_type %in% 
               eval(input_checkboxgroup(
                c("ARSON", "ASSAULT", "BATTERY", "BURGLARY", "CONCEALED CARRY LICENSE VIOLATION", 
                  "CRIMINAL DAMAGE", "CRIMINAL TRESPASS", "CRIME SEXUAL ASSAULT", "DECEPTIVE PRACTICE", 
                  "GAMBLING", "HOMICIDE", "INTERFERENCE WITH PUBLIC OFFICER", "INTIMIDATION", 
                  "KIDNAPPING", "LIQUOR LAW VIOLATION", "MOTOR VEHICLE THEFT", "NARCOTICS", 
                  "NON-CRIMINAL (SUBJECT SPECIFIED)", "OBSCENITY", "OTHER NARCOTIC VIOLATION", 
                  "OTHER OFFENSE", "OFFENSE INVOLVING CHILDREN", "PROSTITUTION", "PUBLIC INDECENCY", 
                  "PUBLIC PEACE VIOLATION", "ROBBERY", "SEX OFFENSE", "STALKING", "THEFT", "WEAPONS VIOLATION"), 
                selected = c("ARSON"),
                label = "Choose a primary type of crime"))) %>%
     layer_points() %>%
      add_tooltip(function(crime){paste0(
        "arrests: ", round(crime$arrests), "<br>",
        "year: ", round(crime$year))}) %>%
      add_axis(
        "y", 
        title_offset = 40, 
        title = "Number of Arrests", 
        properties = axis_props(title = list(fontSize = 15))) %>%
      add_axis(
        "x", 
        title_offset = 40, 
        title = "Year", 
        properties = axis_props(title = list(fontSize = 15)), 
        format = "####") %>%
      add_legend("fill", title = "Primary Type of Crime") %>%
      bind_shiny("p", "p_ui")
      }
    ))

}
```
